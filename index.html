<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link href='https://fonts.googleapis.com/css?family=Architects+Daughter' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="stylesheets/pygment_trac.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print" />

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <title>Nadoni by pvandervelde</title>
  </head>

  <body>
    <header>
      <div class="inner">
        <h1>Nadoni</h1>
        <h2>nAdoni is a library that provides a way to check for updates to one or more binaries via an update manifest, and then to download an archive containing the updated binaries.</h2>
        <a href="https://github.com/pvandervelde/nAdoni" class="button"><small>View project on</small>GitHub</a>
      </div>
    </header>

    <div id="content-wrapper">
      <div class="inner clearfix">
        <section id="main-content">
          <h1>
<a name="nadoni" class="anchor" href="#nadoni"><span class="octicon octicon-link"></span></a>nAdoni</h1>

<p>nAdoni is a library that provides a way to check for updates to one or more binaries via an update manifest, and then to download an archive containing the updated binaries. </p>

<p>The manifest file is an XML file which is signed with an RSA key to provide some form of security in the update process. </p>

<h1>
<a name="setup" class="anchor" href="#setup"><span class="octicon octicon-link"></span></a>Setup</h1>

<h3>
<a name="create-a-manifest-file" class="anchor" href="#create-a-manifest-file"><span class="octicon octicon-link"></span></a>Create a manifest file:</h3>

<ul>
<li>Create an archive file that contains all the files that should be part of the update.</li>
<li>
<p>Get the <code>nAdoni.ManifestBuilder</code> executable and execute the following command line:</p>

<pre><code>nAdoni.ManifestBuilder.exe --ProductName=&lt;PRODUCT-NAME&gt; --ProductVersion=&lt;PRODUCT-VERSION&gt; --FilePath=&lt;FILE-PATH-TO-ARCHIVE-FILE&gt; --DownloadUrl=&lt;URL-TO-ARCHIVE-FILE&gt; --KeyFile=&lt;SIGNING-FILE-PATH&gt; --KeyContainerName=&lt;SIGNING-KEY-CONTAINER-NAME&gt; --Output=&lt;OUTPUT-PATH&gt;
</code></pre>

<p>Where</p>

<ul>
<li>
<strong>PRODUCT-NAME</strong> - The name of the product that should be updated. This name is not directly used in finding new updates but may be used for display purposes in the application that is checking for updates.</li>
<li>
<strong>PRODUCT-VERSION</strong> - The version of the product that is contained in the archive file. An application looking for updates will compare their version number with this one in order to determine if it should update or not.</li>
<li>
<strong>FILE-PATH-TO-ARCHIVE-FILE</strong> - The full path to the archive file, at the moment the manifest file is being created. This path is used to load the archive file and calculate the hash.</li>
<li>
<strong>URL-TO-ARCHIVE-FILE</strong> - The URL from which the archive can be downloaded. </li>
<li>
<strong>SIGNING-FILE-PATH</strong> - The full path to the RSA private key file with which the manifest file should be signed. This parameter does not need to be provided if a key container name is provided.</li>
<li>
<strong>SIGNING-KEY-CONTAINER-NAME</strong> - The name of the key container that contains the private key with which the manifest file should be signed. This parameter does not need to be provided if a key file path is provided.</li>
<li>
<strong>OUTPUT-PATH</strong> - The full path to the location where the output file should be placed.</li>
</ul>
<p>A RSA private key file contains the following information:</p>

<div class="highlight"><pre><span class="nt">&lt;RSAKeyValue&gt;</span>
    <span class="nt">&lt;Modulus&gt;</span>MODULUS_VALUE_HERE<span class="nt">&lt;/Modulus&gt;</span>
    <span class="nt">&lt;Exponent&gt;</span>EXPONENT_VALUE_HERE<span class="nt">&lt;/Exponent&gt;</span>
    <span class="nt">&lt;P&gt;</span>P_VALUE_HERE<span class="nt">&lt;/P&gt;</span>
    <span class="nt">&lt;Q&gt;</span>Q_VALUE_HERE<span class="nt">&lt;/Q&gt;</span>
    <span class="nt">&lt;DP&gt;</span>DP_VALUE_HERE<span class="nt">&lt;/DP&gt;</span>
    <span class="nt">&lt;DQ&gt;</span>DQ_VALUE_HERE<span class="nt">&lt;/DQ&gt;</span>
    <span class="nt">&lt;InverseQ&gt;</span>INVERSE_Q_VALUE_HERE<span class="nt">&lt;/InverseQ&gt;</span>
    <span class="nt">&lt;D&gt;</span>D_VALUE_HERE<span class="nt">&lt;/D&gt;</span>
<span class="nt">&lt;/RSAKeyValue&gt;</span>
</pre></div>

<p>This kind of file can be written with the following code</p>

<div class="highlight"><pre>    <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">rsa</span> <span class="p">=</span> <span class="k">new</span> <span class="n">RSACryptoServiceProvider</span><span class="p">(</span><span class="n">s_KeySize</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="k">try</span>
        <span class="p">{</span>
            <span class="c1">// Write the public key file</span>
            <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">writer</span> <span class="p">=</span> <span class="k">new</span> <span class="n">StreamWriter</span><span class="p">(</span><span class="k">new</span> <span class="n">FileStream</span><span class="p">(</span><span class="n">s_PublicKeyFile</span><span class="p">,</span> <span class="n">FileMode</span><span class="p">.</span><span class="n">Create</span><span class="p">,</span> <span class="n">FileAccess</span><span class="p">.</span><span class="n">Write</span><span class="p">,</span> <span class="n">FileShare</span><span class="p">.</span><span class="n">None</span><span class="p">)))</span>
            <span class="p">{</span>
                <span class="kt">var</span> <span class="n">publicKeyXml</span> <span class="p">=</span> <span class="n">rsa</span><span class="p">.</span><span class="n">ToXmlString</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>
                <span class="n">writer</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="n">publicKeyXml</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="c1">// Write the privat key file</span>
            <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">writer</span> <span class="p">=</span> <span class="k">new</span> <span class="n">StreamWriter</span><span class="p">(</span><span class="k">new</span> <span class="n">FileStream</span><span class="p">(</span><span class="n">s_PrivateKeyFile</span><span class="p">,</span> <span class="n">FileMode</span><span class="p">.</span><span class="n">Create</span><span class="p">,</span> <span class="n">FileAccess</span><span class="p">.</span><span class="n">Write</span><span class="p">,</span> <span class="n">FileShare</span><span class="p">.</span><span class="n">None</span><span class="p">)))</span>
            <span class="p">{</span>
                <span class="kt">var</span> <span class="n">privateKeyXml</span> <span class="p">=</span> <span class="n">rsa</span><span class="p">.</span><span class="n">ToXmlString</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
                <span class="n">writer</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="n">privateKeyXml</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">finally</span>
        <span class="p">{</span>
            <span class="c1">// Make sure we're not storing this key in the machine container.</span>
            <span class="n">rsa</span><span class="p">.</span><span class="n">PersistKeyInCsp</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
</pre></div>
</li>
</ul><h3>
<a name="in-the-application" class="anchor" href="#in-the-application"><span class="octicon octicon-link"></span></a>In the application</h3>

<div class="highlight"><pre>
<span class="kt">var</span> <span class="n">updater</span> <span class="p">=</span> <span class="k">new</span> <span class="n">NAdoni</span><span class="p">.</span><span class="n">Updater</span><span class="p">();</span>

<span class="c1">// Check for updates</span>
<span class="kt">var</span> <span class="n">info</span> <span class="p">=</span> <span class="n">updater</span><span class="p">.</span><span class="n">MostRecentUpdateOnRemoteServer</span><span class="p">(</span><span class="n">manifestUri</span><span class="p">,</span> <span class="n">publicKeyXml</span><span class="p">,</span> <span class="n">currentVersion</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">UpdateIsAvailableAndValid</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">task</span> <span class="p">=</span> <span class="n">updater</span><span class="p">.</span><span class="n">StartDownloadAsync</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
    <span class="n">task</span><span class="p">.</span><span class="n">Wait</span><span class="p">();</span>

    <span class="kt">var</span> <span class="n">fileInfo</span> <span class="p">=</span> <span class="n">task</span><span class="p">.</span><span class="n">Result</span><span class="p">;</span>

    <span class="c1">// Now you have a FileInfo object with the path to your archive file</span>
<span class="p">}</span>

</pre></div>

<h1>
<a name="installation-instructions" class="anchor" href="#installation-instructions"><span class="octicon octicon-link"></span></a>Installation instructions</h1>

<p>The library section of nAdoni is available on <a href="http://www.nuget.org">NuGet.org</a>. And the manifest builder is available as ZIP archive from the <a href="https://github.com/pvandervelde/nAdoni/releases">releases page</a>.</p>

<h1>
<a name="how-to-build" class="anchor" href="#how-to-build"><span class="octicon octicon-link"></span></a>How to build</h1>

<p>The solution files are created in Visual Studio 2012 (using .NET 4.5) and the entire project can be build by invoking MsBuild on the nadoni.integration.msbuild script. This will build the binaries, the NuGet package and the ZIP archive. The binaries will be placed in the <code>build\bin\AnyCpu\Release</code> directory and the NuGet package and the ZIP archive will be placed in the <code>build\deploy</code> directory.</p>

<p>Note that the build scripts assume that:</p>

<ul>
<li>The binaries should be signed, however the SNK key file is not included in the repository so a new key file has to be <a href="http://msdn.microsoft.com/en-us/library/6f05ezxy(v=vs.110).aspx">created</a>. The key file is referenced through an environment variable called <code>SOFTWARE_SIGNING_KEY_PATH</code> that has as value the full path of the key file. </li>
<li>GIT can be found on the PATH somewhere so that it can be called to get the hash of the last commit in the current repository. This hash is embedded in the nuclei assemblies together with information about the build configuration and build time and date.</li>
</ul><h1>
<a name="origin" class="anchor" href="#origin"><span class="octicon octicon-link"></span></a>Origin</h1>

<p>This code of nAdoni is based on the code for an <a href="http://blogs.msdn.com/b/dotnetinterop/archive/2008/03/28/simple-auto-update-for-wpf-apps.aspx">simple auto-update library for WPF applications</a> which is licensed under the <a href="http://opensource.org/licenses/ms-pl">Ms-PL license</a>.</p>
        </section>

        <aside id="sidebar">
          <a href="https://github.com/pvandervelde/nAdoni/zipball/master" class="button">
            <small>Download</small>
            .zip file
          </a>
          <a href="https://github.com/pvandervelde/nAdoni/tarball/master" class="button">
            <small>Download</small>
            .tar.gz file
          </a>

          <p class="repo-owner"><a href="https://github.com/pvandervelde/nAdoni"></a> is maintained by <a href="https://github.com/pvandervelde">pvandervelde</a>.</p>

          <p>This page was generated by <a href="pages.github.com">GitHub Pages</a> using the Architect theme by <a href="https://twitter.com/jasonlong">Jason Long</a>.</p>
        </aside>
      </div>
    </div>

  
  </body>
</html>